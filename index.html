<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Widget Diagnostic Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f4f8;
      padding: 20px;
      margin: 0;
    }

    .container {
      max-width: 600px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 25px;
      margin: 0 auto;
    }

    h2 {
      color: #2c3e50;
      text-align: center;
    }

    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      background-color: #f8f9fa;
    }

    .test-section h3 {
      margin-top: 0;
      color: #495057;
    }

    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: white;
    }

    .btn-primary { background-color: #007bff; }
    .btn-success { background-color: #28a745; }
    .btn-warning { background-color: #ffc107; color: #212529; }
    .btn-danger { background-color: #dc3545; }

    .debug-log {
      background-color: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
      white-space: pre-wrap;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-red { background-color: #dc3545; }
    .status-green { background-color: #28a745; }
    .status-yellow { background-color: #ffc107; }

    input, select {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
  </style>
</head>

<!-- Your EXACT Connect Widget Script -->
<script type="text/javascript">
  (function(w, d, x, id){
    s=d.createElement('script');
    s.src='https://sharecare-hds-dev-p3f.my.connect.aws/connectwidget/static/amazon-connect-chat-interface-client.js';
    s.async=1;
    s.id=id;
    s.onload = function() {
      console.log('Widget script loaded successfully');
      window.widgetScriptLoaded = true;
    };
    s.onerror = function() {
      console.error('Failed to load widget script');
      window.widgetScriptError = true;
    };
    d.getElementsByTagName('head')[0].appendChild(s);
    w[x] = w[x] || function() { (w[x].ac = w[x].ac || []).push(arguments) };
  })(window, document, 'amazon_connect', '51bb78eb-2024-4bab-a426-c3ca21e14331');
</script>

<body>
  <div class="container">
    <h2>Amazon Connect Widget Diagnostic</h2>
    
    <!-- Test Section 1: Widget Loading -->
    <div class="test-section">
      <h3><span id="test1-status" class="status-indicator status-yellow"></span>Test 1: Widget Script Loading</h3>
      <p>Status: <span id="test1-result">Checking...</span></p>
      <button class="btn-primary" onclick="test1_checkWidgetScript()">Check Widget Script</button>
    </div>

    <!-- Test Section 2: Widget Function -->
    <div class="test-section">
      <h3><span id="test2-status" class="status-indicator status-yellow"></span>Test 2: Widget Function Availability</h3>
      <p>Status: <span id="test2-result">Not tested</span></p>
      <button class="btn-primary" onclick="test2_checkWidgetFunction()">Check Widget Function</button>
    </div>

    <!-- Test Section 3: Widget Configuration -->
    <div class="test-section">
      <h3><span id="test3-status" class="status-indicator status-yellow"></span>Test 3: Widget Configuration</h3>
      <p>Status: <span id="test3-result">Not tested</span></p>
      <button class="btn-primary" onclick="test3_configureWidget()">Configure Widget</button>
    </div>

    <!-- Test Section 4: Basic Widget Open -->
    <div class="test-section">
      <h3><span id="test4-status" class="status-indicator status-yellow"></span>Test 4: Basic Widget Open (No Attributes)</h3>
      <p>Status: <span id="test4-result">Not tested</span></p>
      <button class="btn-warning" onclick="test4_openBasicWidget()">Open Widget (Basic)</button>
    </div>

    <!-- Test Section 5: Widget with Session Attributes -->
    <div class="test-section">
      <h3><span id="test5-status" class="status-indicator status-yellow"></span>Test 5: Widget with Session Attributes</h3>
      <p>Status: <span id="test5-result">Not tested</span></p>
      <div>
        <label>Your Agent Name:</label>
        <input type="text" id="agentName" placeholder="Enter your agent name" value="TestAgent">
        
        <label>Target Agent:</label>
        <select id="targetAgent">
          <option value="Agent1">Agent1</option>
          <option value="Agent2">Agent2</option>
          <option value="Agent3">Agent3</option>
        </select>
      </div>
      <button class="btn-success" onclick="test5_openWithAttributes()">Open Widget (With Attributes)</button>
    </div>

    <!-- Test Section 6: DOM Inspection -->
    <div class="test-section">
      <h3><span id="test6-status" class="status-indicator status-yellow"></span>Test 6: DOM Widget Elements</h3>
      <p>Status: <span id="test6-result">Not tested</span></p>
      <button class="btn-primary" onclick="test6_inspectDOM()">Inspect Widget DOM</button>
    </div>

    <!-- Debug Log -->
    <div class="debug-log" id="debugLog">Diagnostic log will appear here...\n</div>
  </div>

  <script>
    function debugLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logElement = document.getElementById('debugLog');
      const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'ðŸ“';
      const newMessage = `[${timestamp}] ${prefix} ${message}\n`;
      logElement.textContent += newMessage;
      logElement.scrollTop = logElement.scrollHeight;
      console.log(`[${timestamp}] ${message}`);
    }

    function setTestStatus(testId, status, message) {
      const statusElement = document.getElementById(`${testId}-status`);
      const resultElement = document.getElementById(`${testId}-result`);
      
      statusElement.className = `status-indicator status-${status}`;
      resultElement.textContent = message;
    }

    // Test 1: Check if widget script loaded
    function test1_checkWidgetScript() {
      debugLog('Running Test 1: Widget Script Loading');
      
      if (window.widgetScriptError) {
        setTestStatus('test1', 'red', 'Script failed to load');
        debugLog('Widget script failed to load', 'error');
        return;
      }
      
      if (window.widgetScriptLoaded) {
        setTestStatus('test1', 'green', 'Script loaded successfully');
        debugLog('Widget script loaded successfully', 'success');
      } else {
        setTestStatus('test1', 'yellow', 'Script loading...');
        debugLog('Widget script still loading...', 'warning');
        
        // Check again in 2 seconds
        setTimeout(() => {
          if (window.widgetScriptLoaded) {
            setTestStatus('test1', 'green', 'Script loaded successfully');
            debugLog('Widget script loaded successfully (delayed)', 'success');
          } else {
            setTestStatus('test1', 'red', 'Script failed to load');
            debugLog('Widget script failed to load after timeout', 'error');
          }
        }, 2000);
      }
    }

    // Test 2: Check if amazon_connect function is available
    function test2_checkWidgetFunction() {
      debugLog('Running Test 2: Widget Function Availability');
      
      if (typeof amazon_connect === 'function') {
        setTestStatus('test2', 'green', 'amazon_connect function available');
        debugLog('amazon_connect function is available', 'success');
        
        // Check if function queue exists
        if (amazon_connect.ac && Array.isArray(amazon_connect.ac)) {
          debugLog(`Function queue has ${amazon_connect.ac.length} pending calls`, 'info');
        }
      } else {
        setTestStatus('test2', 'red', 'amazon_connect function not available');
        debugLog('amazon_connect function is NOT available', 'error');
        debugLog('Type of amazon_connect: ' + typeof amazon_connect, 'info');
      }
    }

    // Test 3: Configure widget
    function test3_configureWidget() {
      debugLog('Running Test 3: Widget Configuration');
      
      if (typeof amazon_connect !== 'function') {
        setTestStatus('test3', 'red', 'Widget function not available');
        debugLog('Cannot configure - widget function not available', 'error');
        return;
      }

      try {
        // Configure styles
        amazon_connect('styles', { 
          iconType: 'CHAT', 
          openChat: { color: '#ffffff', backgroundColor: '#00BFA5' }, 
          closeChat: { color: '#ffffff', backgroundColor: '#00BFA5'} 
        });
        debugLog('Widget styles configured', 'success');

        // Set snippet ID
        amazon_connect('snippetId', 'QVFJREFIaFg3VVJ2dFRXb2IrUUdndUkvUzRJMnRnQ1NJL3Erc1JKT0lFQ3lCQlNlUEFFSnBlREpsTldscUlya3hNbjNkYTJ4QUFBQWJqQnNCZ2txaGtpRzl3MEJCd2FnWHpCZEFnRUFNRmdHQ1NxR1NJYjNEUUVIQVRBZUJnbGdoa2dCWlFNRUFTNHdFUVFNNHRpTGthdExjVTRENmI3dUFnRVFnQ3Z3bHNhYkx6THBEM3dFN2JOWFkzZEtuVHJGZ1JWVnM3Sk5lOW5Mb2oxNFk0bUxURXRHRG02b1c4Wmk6OkthQ1pySzRxaFF4OEJDd3RYazUreTQyTVc0R2x3ZnJUQmdmejBhTG5vOXZvN25Pc3ZlNmZ1SmxtWWRZa09wc2dITkVDRDIxbVdBazBzczFKSzZ2ZncvakRTczRFTHUwV2hlUTk2UU5QbzJacnJMS294NjFCeXNXT1ZDOVNFNHlvbHpvSjdjcnJLL0V1YytsamZwSVRLcXpIZlcwQTlGcz0=');
        debugLog('Snippet ID configured', 'success');

        // Set supported content types
        amazon_connect('supportedMessagingContentTypes', [ 
          'text/plain', 
          'text/markdown', 
          'application/vnd.amazonaws.connect.message.interactive', 
          'application/vnd.amazonaws.connect.message.interactive.response' 
        ]);
        debugLog('Content types configured', 'success');

        setTestStatus('test3', 'green', 'Widget configured successfully');
        debugLog('Widget configuration completed', 'success');

      } catch (error) {
        setTestStatus('test3', 'red', 'Configuration failed: ' + error.message);
        debugLog('Widget configuration failed: ' + error.message, 'error');
      }
    }

    // Test 4: Try to open widget without session attributes
    function test4_openBasicWidget() {
      debugLog('Running Test 4: Basic Widget Open');
      
      if (typeof amazon_connect !== 'function') {
        setTestStatus('test4', 'red', 'Widget function not available');
        debugLog('Cannot open widget - function not available', 'error');
        return;
      }

      try {
        debugLog('Attempting to open widget without attributes...');
        amazon_connect('openChat');
        
        setTestStatus('test4', 'green', 'Open command sent - check if widget appears');
        debugLog('Widget open command sent successfully', 'success');
        
        // Check after 3 seconds if widget appeared
        setTimeout(() => {
          test6_inspectDOM();
        }, 3000);
        
      } catch (error) {
        setTestStatus('test4', 'red', 'Failed to open widget: ' + error.message);
        debugLog('Failed to open widget: ' + error.message, 'error');
      }
    }

    // Test 5: Open widget with session attributes
    function test5_openWithAttributes() {
      debugLog('Running Test 5: Widget with Session Attributes');
      
      const agentName = document.getElementById('agentName').value.trim();
      const targetAgent = document.getElementById('targetAgent').value;
      
      if (!agentName) {
        setTestStatus('test5', 'red', 'Please enter your agent name');
        debugLog('Agent name not provided', 'error');
        return;
      }
      
      if (typeof amazon_connect !== 'function') {
        setTestStatus('test5', 'red', 'Widget function not available');
        debugLog('Cannot open widget - function not available', 'error');
        return;
      }

      try {
        // Prepare session attributes
        const sessionAttributes = {
          'target_agent_username': targetAgent,
          'initiating_agent': agentName,
          'chat_type': 'agent_to_agent',
          'timestamp': new Date().toISOString()
        };

        debugLog('Session attributes: ' + JSON.stringify(sessionAttributes, null, 2));

        // Set session attributes
        amazon_connect('sessionAttributes', sessionAttributes);
        debugLog('Session attributes set', 'success');

        // Set contact attributes
        amazon_connect('contactAttributes', {
          'TargetAgent': targetAgent,
          'InitiatingAgent': agentName,
          'ChatType': 'AgentToAgent'
        });
        debugLog('Contact attributes set', 'success');

        // Open widget
        debugLog('Opening widget with attributes...');
        amazon_connect('openChat');
        
        setTestStatus('test5', 'green', 'Widget opened with attributes');
        debugLog('Widget with attributes opened successfully', 'success');
        
        // Check DOM after 3 seconds
        setTimeout(() => {
          test6_inspectDOM();
        }, 3000);
        
      } catch (error) {
        setTestStatus('test5', 'red', 'Failed: ' + error.message);
        debugLog('Failed to open widget with attributes: ' + error.message, 'error');
      }
    }

    // Test 6: Inspect DOM for widget elements
    function test6_inspectDOM() {
      debugLog('Running Test 6: DOM Widget Elements Inspection');
      
      const widgetSelectors = [
        '.connect-chat-interface',
        '[id*="connect"]',
        '[class*="connect"]',
        '[class*="chat"]',
        'iframe[src*="connect"]',
        'div[data-widget]'
      ];

      let foundElements = [];
      
      widgetSelectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        if (elements.length > 0) {
          foundElements.push(`${selector}: ${elements.length} elements`);
          elements.forEach((el, index) => {
            debugLog(`  Element ${index + 1}: ${el.tagName}, classes: ${el.className}, id: ${el.id}`, 'info');
            debugLog(`  Visible: ${el.offsetWidth > 0 && el.offsetHeight > 0}, Display: ${getComputedStyle(el).display}`, 'info');
          });
        }
      });

      if (foundElements.length > 0) {
        setTestStatus('test6', 'green', `Found ${foundElements.length} widget element types`);
        debugLog('Widget DOM elements found:', 'success');
        foundElements.forEach(element => {
          debugLog('  ' + element, 'info');
        });
      } else {
        setTestStatus('test6', 'red', 'No widget elements found in DOM');
        debugLog('No widget elements found in DOM', 'warning');
      }

      // Also check for any iframes
      const iframes = document.querySelectorAll('iframe');
      if (iframes.length > 0) {
        debugLog(`Found ${iframes.length} iframes:`, 'info');
        iframes.forEach((iframe, index) => {
          debugLog(`  Iframe ${index + 1}: src=${iframe.src}, class=${iframe.className}`, 'info');
        });
      }
    }

    // Auto-run initial tests when page loads
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('Page loaded - starting automatic diagnostics...');
      
      // Run Test 1 immediately
      setTimeout(() => test1_checkWidgetScript(), 500);
      
      // Run Test 2 after 2 seconds
      setTimeout(() => test2_checkWidgetFunction(), 2000);
      
      // Auto-configure widget after 3 seconds
      setTimeout(() => test3_configureWidget(), 3000);
    });
  </script>
</body>
</html>